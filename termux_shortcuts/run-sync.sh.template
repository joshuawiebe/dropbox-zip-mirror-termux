#!/data/data/com.termux/files/usr/bin/bash
set -euo pipefail

# === Dropbox Mirror Sync Script ===
# Works as Termux shortcut, Job Scheduler task or manual execution.

# --- Detect repo root automatically ---
SCRIPT_PATH="$(realpath "$0")"
SCRIPT_DIR="$(dirname "$SCRIPT_PATH")"

# Look for .git folder to detect repo root
if [ -d "$SCRIPT_DIR/.git" ]; then
    REPO_ROOT="$SCRIPT_DIR"
elif [ -d "$SCRIPT_DIR/../.git" ]; then
    REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
elif [ -d "$HOME/dropbox-zip-mirror-termux/.git" ]; then
    REPO_ROOT="$HOME/dropbox-zip-mirror-termux"
else
    echo "âŒ ERROR: Could not detect repository root."
    echo "Please adjust REPO_ROOT manually in this script."
    exit 1
fi

ENV_FILE="$REPO_ROOT/.dropbox_mirror.env"

# --- Load configuration ---
if [ ! -f "$ENV_FILE" ]; then
    echo "âŒ ERROR: Missing config file: $ENV_FILE"
    echo "Run ./setup_termux.sh from the repo root first!"
    exit 1
fi

# shellcheck disable=SC1090
source "$ENV_FILE"

# --- Determine Python interpreter ---
if [ -n "${VENV_DIR:-}" ] && [ -x "$VENV_DIR/bin/python" ]; then
    PYTHON="$VENV_DIR/bin/python"
elif [ -x "$REPO_ROOT/.venv/bin/python" ]; then
    PYTHON="$REPO_ROOT/.venv/bin/python"
elif [ -x "$REPO_ROOT/venv/bin/python" ]; then
    PYTHON="$REPO_ROOT/venv/bin/python"
elif command -v python3 >/dev/null 2>&1; then
    PYTHON="$(command -v python3)"
elif command -v python >/dev/null 2>&1; then
    PYTHON="$(command -v python)"
else
    echo "âŒ ERROR: No Python interpreter found!"
    exit 1
fi

# --- Use log path from config ---
LOG_FILE="${LOG_PATH:-$REPO_ROOT/sync.log}"

# --- Termux Job Scheduler support ---
if [ -n "${TERMUX_JOB_UUID:-}" ]; then
    echo "ðŸ”¹ Running as scheduled job (UUID: $TERMUX_JOB_UUID)"
fi

echo "=== Dropbox Mirror Sync ==="
date

# --- Run sync ---
{
    echo "[$(date)] Starting sync..."
    "$PYTHON" "$REPO_ROOT/sync_dropbox.py"
    echo "[$(date)] âœ… Sync completed successfully"
} >>"$LOG_FILE" 2>&1 || {
    echo "[$(date)] âŒ Sync failed" >>"$LOG_FILE"
    exit 1
}

echo "Log written to $LOG_FILE"
echo "=== Done ==="
